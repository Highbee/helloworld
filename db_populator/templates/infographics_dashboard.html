{% extends 'base.html' %}

{% block title %}Infographics Dashboard{% endblock %}

{% block content %}
    <h1>Infographics Dashboard</h1>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    Daily Production
                </div>
                <div class="card-body">
                    <canvas id="dailyProductionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    Weekly Production
                </div>
                <div class="card-body">
                    <canvas id="weeklyProductionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    Monthly Production
                </div>
                <div class="card-body">
                    <canvas id="monthlyProductionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to generate random colors for the charts
        function getRandomColor() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Daily Production Chart
        fetch('/api/daily_production/')
            .then(response => response.json())
            .then(data => {
                const products = [...new Set(data.map(item => item.product__product_name))];
                const labels = [...new Set(data.map(item => item.day))].sort();

                const datasets = products.map(product => {
                    return {
                        label: product,
                        data: labels.map(label => {
                            const item = data.find(d => d.day === label && d.product__product_name === product);
                            return item ? item.total_produced : 0;
                        }),
                        backgroundColor: getRandomColor(),
                    };
                });

                new Chart(document.getElementById('dailyProductionChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        }
                    }
                });
            });

        // Weekly Production Chart
        fetch('/api/weekly_production/')
            .then(response => response.json())
            .then(data => {
                const products = [...new Set(data.map(item => item.product__product_name))];
                const labels = [...new Set(data.map(item => item.week))].sort();

                const datasets = products.map(product => {
                    return {
                        label: product,
                        data: labels.map(label => {
                            const item = data.find(d => d.week === label && d.product__product_name === product);
                            return item ? item.total_produced : 0;
                        }),
                        borderColor: getRandomColor(),
                        fill: false,
                    };
                });

                new Chart(document.getElementById('weeklyProductionChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    }
                });
            });

        // Monthly Production Chart
        fetch('/api/monthly_production/')
            .then(response => response.json())
            .then(data => {
                const products = [...new Set(data.map(item => item.product__product_name))];
                const labels = [...new Set(data.map(item => item.month))].sort();

                const datasets = products.map(product => {
                    return {
                        label: product,
                        data: labels.map(label => {
                            const item = data.find(d => d.month === label && d.product__product_name === product);
                            return item ? item.total_produced : 0;
                        }),
                        borderColor: getRandomColor(),
                        fill: false,
                    };
                });

                new Chart(document.getElementById('monthlyProductionChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    }
                });
            });
    </script>
{% endblock %}
